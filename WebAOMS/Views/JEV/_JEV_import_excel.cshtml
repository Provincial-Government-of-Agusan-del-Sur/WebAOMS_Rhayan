
@{
    Layout = null;
}

<script src="@Url.Content("~/Scripts/akot/xls.core.min.js")"></script>
<script src="@Url.Content("~/Scripts/akot/xlsx.core.min.js")"></script>

<div class="box" style="margin-bottom:0px!important">
    <div class="box-body" style="padding-bottom:0px!important">
        <div class="row">
                <script>
                        //function r_dp_accountname() {
                        //    var cbo_accountname = $("#dp_accountname").data("kendoDropDownList");
                        //    cbo_accountname.dataSource.read();
                        //    r_grid_Bathcno();
                        //}
                        
                        //function r_grid_Bathcno() {
                        //    var cbo_accountname = $("#Grid_batchno_payroll").data("kendoGrid");
                        //    cbo_accountname.dataSource.read();
                        //}

                        //function refresh_import_grid() {
                        //    var grid_batchno = $("#grid_empname").data("kendoGrid");
                        //    grid_batchno.dataSource.read();
                        //}
                </script>
                <div class="col-md-12">
                    <div class="box-head no-padding" style="line-height:20px!important">
                        <label for="Accountname" class="control-label">Account Name</label>
                    </div>
                    <script>
                        function para_payroll_mapped() {
                            return { PayrollType: 1 }
                        }
                    </script>
                        @(Html.Kendo().DropDownList()
                        .Name("dp_accountname")
                        .DataTextField("Accountname")
                        .DataValueField("ChartAccountChildID")
                        .Filter("Contains")
                        .AutoBind(false)
                        .DataSource(source =>
                        {
                            source.Read(read =>
                            {
                                read.Action("DataSource_Get_Accountname_payroll_mapped", "JEV").Data("para_payroll_mapped");
                            });
                        })
                        .HtmlAttributes(new { style = "width: 100%" })
                        )
                </div>
            <script>
                function load_emp(){
                    //alert(getarrayoffice())
                    refresh_import_grid()
                }
                function ExportToTable() {
                    var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.xlsx|.xls)$/;
                    /*Checks whether the file is a valid excel file*/
                    if (regex.test($("#excelfile").val().toLowerCase())) {
                        var xlsxflag = false; /*Flag for checking whether excel is .xls format or .xlsx format*/
                        if ($("#excelfile").val().toLowerCase().indexOf(".xlsx") > 0) {
                            xlsxflag = true;
                        }
                        /*Checks whether the browser supports HTML5*/
                        if (typeof (FileReader) != "undefined") {
                            var reader = new FileReader();
                            reader.onload = function (e) {
                                var data = e.target.result;

                                /*Converts the excel data in to object*/
                                if (xlsxflag) {
                                    var workbook = XLSX.read(data, { type: 'binary' });
                                }
                                else {
                                    var workbook = XLS.read(data, { type: 'binary' });
                                }
                                /*Gets all the sheetnames of excel in to a variable*/


                                var sheet_name_list = workbook.SheetNames;

                                var cnt = 0; /*This is used for restricting the script to consider only first sheet of excel*/
                                sheet_name_list.forEach(function (y) { /*Iterate through all sheets*/
                                    /*Convert the cell value to Json*/
                                    if (xlsxflag) {
                                        var exceljson = XLSX.utils.sheet_to_json(workbook.Sheets[y]);
                                    }
                                    else {
                                        var exceljson = XLS.utils.sheet_to_row_object_array(workbook.Sheets[y]);
                                    }

                                    if (exceljson.length > 0 && cnt == 0) {
                                        BindTable(exceljson);
                                        cnt++;
                                    }
                                });

                                $('#exceltable').show();
                            }
                            if (xlsxflag) {/*If excel file is .xlsx extension than creates a Array Buffer from excel*/
                                reader.readAsArrayBuffer($("#excelfile")[0].files[0]);
                            }
                            else {
                                reader.readAsBinaryString($("#excelfile")[0].files[0]);
                            }
                        }
                        else {
                            alert("Sorry! Your browser does not support HTML5!");
                        }
                    }
                    else {
                        alert("Please upload a valid Excel file!");
                    }
                }

                function totalAmount(e) {
                    alert('')
                    var total = 0;
                    var grid = $("#exceltable").data("kendoGrid");
                    var gridData = grid.dataSource.view();
                    for (var i = 0; i < gridData.length; i++) {
                        total += parseFloat(gridData[i].Amount);
                    }
                    $("#txt_total").val("Total Amount: " + addCommas(total.toFixed(2)));

                }
                function BindTable(jsondata) {

                    var aliasListDataSource = new kendo.data.DataSource({
                        transport: {
                            read: function (op) {
                                op.success(jsondata);
                            }
                        },
                        pageSize: 10
                    });

                    $("#exceltable").kendoGrid({
                        dataSource: {
                            transport: {
                                read: function (op) {
                                    op.success(jsondata);
                                }
                            },
                            pageSize: 1000
                        },
                        height: 300,
                        groupable: false,
                        sortable: true,
                        pageable: {
                            refresh: false,
                            pageSizes: false,
                            buttonCount: 5
                        },
                        columns: [
                            {
                                field: "eid",
                                title: "Code",
                                filterable: false,
                                width: 90
                            }, {
                                field: "Empname",
                                title: "Emp Name",
                                width: 200

                            }, {
                                field: "Amount",
                                title: "Amount",
                                attributes: {
                                    "class": "table-cell",
                                    style: "text-align: right;"
                                },
                                width: 100
                            }
                        ],
                        dataBound: totalAmount
                    });
                }

                /*Function used to get all column names from JSON and bind the html table header*/
                function BindTableHeader(jsondata) {
                    var columnSet = [];
                    var headerTr$ = $('<tr/>');
                    for (var i = 0; i < jsondata.length; i++) {
                        var rowHash = jsondata[i];
                        for (var key in rowHash) {
                            if (rowHash.hasOwnProperty(key)) {
                                if ($.inArray(key, columnSet) == -1) {/*Adding each unique column names to a variable array*/
                                    columnSet.push(key);
                                    headerTr$.append($('<th/>').html(key));
                                }
                            }
                        }
                    }
                    return columnSet;
                }
            </script>
            <div class="col-md-12"  style="padding-top:5px!important ">
                <input type="file" id="excelfile" />  
            </div>
            <div class="col-md-6"  style="padding-top:5px!important ">
                    <div data-toggle="buttons">
                        @(Html.Kendo().Button()
                        .Name("btn_load")
                        .Content("<i class=\"fa fa-excel fa-lg \"></i> Load Data")
                        .HtmlAttributes(new { type = "button", @class = "k-button" })
                        .Events(ev => ev.Click("ExportToTable")))
                        @*@(Html.Kendo().Button()
                        .Name("btn_browse")
                        .Content("<i class=\"fa fa-refresh fa-lg \"></i> Browse Excel File")
                        .HtmlAttributes(new { type = "button", @class = "k-button" })
                        .Events(ev => ev.Click("browse_excel")))*@


                        <label class="btn radio-inline btn-radio-success-inverse active pull-right">
                            <input name="isDebitOption" id="isDebitOption1" value="1" type="radio">Debit
                        </label>
                        <label class="btn radio-inline btn-radio-success-inverse pull-right">
                            <input name="isDebitOption" id="isDebitOption2" value="0" type="radio">Credit
                        </label>
                        <input id="isDebitOptionID" value="1" hidden />
                        <script>
                                $(function () {
                                    $('input[name="isDebitOption"]').bind('change', function () {
                                        $("#isDebitOptionID").val($(this).val())
                                        //alert($(this).val())
                                    });
                                });
                                
                        </script>
                </div>
            </div>
            <div class="col-md-6" style="padding-top:5px!important ">

                <div class="input-group no-padding col-md-12">
                    <input id="txt_search_batchno" type="text" class="form-control navbar-input" placeholder="Search...">
                    <span class="input-group-btn">

                    </span>
                </div>
            </div>


                <div class="form-group">
                    
                </div>
                <script>
                    //function param_grid_import() {

                    //    var year = kendo.toString($('#dtp_payrmentperiod').data('kendoDatePicker').value(), 'yyyy').toString();
                    //    var month = kendo.toString($('#dtp_payrmentperiod').data('kendoDatePicker').value(), 'MM').toString();
                    //    var dp_emptatus = $("#dp_empstatus").data("kendoDropDownList").value();
                    //    var dp_accountname = $("#dp_accountname").data("kendoDropDownList").value()
                    //    if (dp_emptatus == '')
                    //    {
                    //        dp_emptatus = 0
                    //    }
                    //    if (dp_accountname == '') {
                    //        dp_accountname = 0
                    //    }
                    //    return { month: month, year: year, officearrayid: getarrayoffice(), payrollempstatus: dp_emptatus, payreffid: dp_accountname }
                    //}

                   

                </script>                
                    <div class="col-md-12">
                     @(Html.Kendo().Grid<dynamic>()
                    .Name("exceltable")
                    .Columns(columns =>
                    {
                        columns.Bound("eid").Width(70).Title("Code").HeaderHtmlAttributes(new { style = "text-align:center" }).HtmlAttributes(new { style = "text-align:center" });
                        columns.Bound("Empname").Width(200);
                        columns.Bound("Amount").Width(130).Format("{0:N2}").HtmlAttributes(new { style = "text-align:right" });

                    })
                    .AutoBind(false)
                    .HtmlAttributes(new { style = "height: 250px;" })
                    .Scrollable()
                    .Sortable()
                    .Pageable(pageable => pageable
                    .Refresh(true)
                    .ButtonCount(5))

                    .DataSource(dataSource => dataSource
                        .Ajax()
                        .Read(read => read.Action("grid_import_null_grid", "JEV"))
                        .PageSize(2000)
                        .ServerOperation(false)
                        .Sort(sort => sort.Add("Empname").Ascending())
                    )
                    )
                        
                    </div>
                </div>


    </div>
</div>
<script>

    function addtoGenerate(gridname, gridnameTodelete, eid, empName, Position) {
        //Selecting Grid
        var vgrid = $("#" + gridname).data("kendoGrid");
        //Selecting dataSource
        var datasource = vgrid.dataSource;
        var newRecord = { eid: eid, Empname: empName, Position: Position };
        //Inserting new row    
        datasource.insert(newRecord);
    }

    $(document).ready(function() {
        @*var datepicker = $("#dtp_post").data("kendoDatePicker");
        datepicker.value('@ViewBag.postdate');*@
    })

    function save_import_entries() {
        startSpin()
        var year = kendo.toString($('#dtp_payrmentperiod').data('kendoDatePicker').value(), 'yyyy').toString();
        var month = kendo.toString($('#dtp_payrmentperiod').data('kendoDatePicker').value(), 'MM').toString();
        var employmentid = $("#dp_empstatus").data("kendoDropDownList").value();
        var dp_batchno = getarrayoffice();
        var dp_accountname = $("#dp_accountname").data("kendoDropDownList").value();
        var isdebit = $("#isDebitOptionID").val();
        var jevid = $("#txt_jevid").val();

        if (dp_accountname == '')
        {
            toastr.warning("Invalid Office name/Batchno...!", 'System Message')
            stopSpin()
            return
        }

        $.post('@Url.Action("save_import_entries_byAccount", "JEV")',
            { year: year, month: month, jevid: jevid, dp_batchno: dp_batchno, employmentid: employmentid, isdebit: isdebit, deductionid: dp_accountname }
        , function (r) {
            if (r.code == 6) {
                stopSpin()
                toastr.success(r.statusName, 'System Message');
                //$("#body_import").html("")
                //$("#mdl_import").modal("hide");
                rgrid_main_account();
            }
            else {
                toastr.warning(r.statusName, 'System Message');
            }
        })
        .fail(function (jqXHR, textStatus, error) {
            stopSpin()
            mg.warning("" + textStatus + "")
        });
    }
</script>
