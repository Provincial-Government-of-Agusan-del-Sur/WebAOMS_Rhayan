
@{
    ViewBag.Title = "Cash Book";
    ViewBag.Title_mini = "Cash Book";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    @@media (min-width: 768px) {
        .modal-xl {
            width: 90%;
            max-width: 1200px;
        }
    }

    .bgGreen {
        background-color: yellowgreen;
    }

    .bgRed {
        background-color: #f09609;
    }
</style>


<div class="box">
    <div class="box-head">
        <header>
            <h4 class="text-bold">@ViewBag.Title_mini</h4>
        </header>
        <div class="tools">
            <div class="btn-group ">
                <a class="btn btn-equal btn-sm btn-refresh"><i class="fa fa-refresh"></i></a>
                <a class="btn btn-equal btn-sm btn-collapse"><i class="fa fa-angle-down"></i></a>
            </div>
        </div>
        <hr />
    </div>
    <div class="box-body">

        <div class="col-md-4">
            <div class="row">
                
                    <label for="FundType">Fund Type</label>
                    @(Html.Kendo().DropDownList()
                              .Name("dp_fundtype_rci")
                              .DataTextField("FundName")
                              .DataValueField("FundID")
                              .DataSource(source =>
                              {
                                  source.Read(read =>
                                  {
                                      read.Action("DataSource_Getfundtype", "Cashier");
                                  });
                              })
                              .HtmlAttributes(new { style = "width: 100%" })
                    )
                

            </div>
            <div class="row">
                <label for="Dateperiod" style="width:100%">For the Period</label>
                @(Html.Kendo().DatePicker()
                        .Name("dtp_period")
                         .Start(CalendarView.Year)
                            .Depth(CalendarView.Year)
                            .Format("MMMM, yyyy")
                            .Value(DateTime.Now)
                        .HtmlAttributes(new { type = "text" })
                        .Events(ev => ev.Change("rgrid_trans_account"))
                        .HtmlAttributes(new { style = "max-width: 150px;width: 100%" })
                )
                <button onclick="load_rci()" class="btn btn-success"> <i class="fa fa-refresh"></i> Load Account</button>
            </div>
            <div class="row">
                <label for="Dateperiod" style="width:100%">Filter</label>
                <div class="input-group no-padding">
                    <input id="txt_search_account" type="text" class="form-control navbar-input" placeholder="Search Bank Account Number/Account name">
                    <span class="input-group-btn">
                        <button class="btn btn-equal" onclick="view_jev_details()" type="button"><i class="fa fa-search"></i></button>
                    </span>
                </div>
            </div>
        </div>
        <script>
            $('#txt_search_account').on('keydown', function (e) {
                var gridData = $("#grid_Account").data("kendoGrid");
                if (e.keyCode == 13) {
                    if ($('#txt_search_account').val() == "") {
                        gridData.dataSource.filter({});
                    }
                    else {
                        ISfn.applyFilter("AccountName", $('#txt_search_account').val(), 'grid_Account')
                        //gridData.dataSource.sort({ field: "AccountName", dir: "asc" });
                    }
                }
            })
            function load_rci() {
                var gridData = $("#grid_Account").data("kendoGrid");
                gridData.dataSource.read();
            }

            function para_RCI_transaction() {
                var year = kendo.toString($('#dtp_period').data('kendoDatePicker').value(), 'yyyy').toString();
                var month = kendo.toString($('#dtp_period').data('kendoDatePicker').value(), 'MM').toString();
                var fundid = $("#dp_fundtype_rci").data("kendoDropDownList").value();
                return { fundid: fundid, year: year, month: month }
            }

            function select_event() {
                var row = $(this.select()).closest("tr"),
                grid = $("#grid_Account").data("kendoGrid"),
                dataItem = grid.dataItem(row);
                $("#txt_Account").val(dataItem.Compositioncode)
                var gridData = $("#grid_transactions").data("kendoGrid");
                gridData.dataSource.read();
            }
        </script>
        <div class="col-md-8">
            <div class="row">

                <label for="Dateperiod" style="width:100%">Accounts</label>
                @(Html.Kendo().Grid<WebAOMS.Models.ufn_CashBook_Accounts_Result>()
                    .Name("grid_Account")
                    .Columns(columns =>
                    {
                    columns.Bound(m => m.BankID).Width(80).Title("Bank Name").HtmlAttributes(new { style = "text-align:center" }).HeaderHtmlAttributes(new { style = "text-align:center" });
                    columns.Bound(m => m.BankAccountNo).Width(80).Title("Account No.").HtmlAttributes(new { style = "text-align:center" }).HeaderHtmlAttributes(new { style = "text-align:center" });
                    columns.Bound(m => m.AccountName).Width(80).Title("Account Name").HtmlAttributes(new { style = "text-align:center" }).HeaderHtmlAttributes(new { style = "text-align:center" });
                    //columns.Bound(m => m.TotalAmount).Width(80).Title("Total Amount").Format("{0:N2}").HtmlAttributes(new { style = "text-align:right" }).HeaderHtmlAttributes(new { style = "text-align:center" });

                        @*columns.Template(@<text></text>)
                            .Width(30)
                            .HtmlAttributes(new { style = "text-align:left;font-size:10" })
                            .ClientTemplate("<button data-original-title=\"view\" type=\"button\" onclick=\"show_rci('#=RCINo#')\" class=\"btn btn-xs btn-inverse btn-equal\" style=\"margin-right:2px\"><i class=\"fa fa-list\"></i></button>");*@
                    })
                        .AutoBind(false)
                        .HtmlAttributes(new { style = "height: 160px;" })
                        .Scrollable()
                        .Sortable()
                        .Pageable(pageable => pageable
                        .Refresh(true)
                        .ButtonCount(5))
                         .Selectable(selectable => selectable
                            .Mode(GridSelectionMode.Single)
                            .Type(GridSelectionType.Row))
                            .Events(e => e.Change("select_event"))
                        .DataSource(dataSource => dataSource
                            .Ajax()
                            .Read(read => read.Action("grid_Accounts", "Cashier").Data("para_RCI_transaction"))
                            .PageSize(200)
                    )

            )
            </div>
                 

            
        </div>
        <hr />

    </div>
</div>
<div class="box">
    <div class="box-head">
        <header>
            <h4 class="text-bold">Transaction List</h4>
        </header>
        <div class="tools">
            <div class="btn-group ">
                <a id="export" href="#" class="btn btn-equal btn-sm btn-excel" style="width:100px"><i class="fa fa-file"></i> Export to excel</a>
                <a class="btn btn-equal btn-sm btn-refresh"><i class="fa fa-refresh"></i></a>
                <a class="btn btn-equal btn-sm btn-collapse"><i class="fa fa-angle-down"></i></a>
            </div>
        </div>
        <hr />
    </div>
    <input id="txt_Account" hidden type="text" />
    <div class="box-body" style="padding-bottom:0px!important">
                <div class="row" style="padding-bottom:10px">
                    <div class="col-md-3 no-padding">
                        <div class="input-group no-padding">
                            <input id="txt_search_checkno" type="text" class="form-control navbar-input" placeholder="Search Ref/Checkno">
                            <span class="input-group-btn">
                                <button class="btn btn-equal" onclick="search_checkno()" type="button"><i class="fa fa-search"></i></button>
                            </span>
                        </div>
                    </div>
                    <div class="col-md-3 no-padding">
                        <div class="input-group no-padding">
                                <button class="btn btn-equal" onclick="search_checkno()" type="button"><i class="fa fa-search"></i></button>
                           
                        </div>
                    </div>
                </div>
                <script>

                    function rgrid_trans_account() {
                        var gridData = $("#grid_transactions").data("kendoGrid");
                        gridData.dataSource.read();
                    }

                    function rgrid_approved_jev() {
                        var gridData = $("#grid_Approved_jev").data("kendoGrid");
                        gridData.dataSource.read();
                    }

                    function para_rci_details() {
                        var year = kendo.toString($('#dtp_period').data('kendoDatePicker').value(), 'yyyy').toString();
                        var month = kendo.toString($('#dtp_period').data('kendoDatePicker').value(), 'MM').toString();
                        //var fundid = $("#dp_fundtype_rci").data("kendoDropDownList").value();
                        return { compositionCode: $('#txt_Account').val(), year: year, month: month, isclosed: 0, byYear: 0 }
                    }

                    $("#export").click(function (e) {
                        var grid = $("#grid_transactions").data("kendoGrid");
                        grid.saveAsExcel();
                    });

                    function show_aprrove_jev(jevid, jevno) {
                        startSpin()
                        $.post('@Url.Action("view_approve_jev", "JEV")', { jevid: jevid }, function (r) {
                            $("#body_approve").html("")
                            stopSpin()
                            $("#body_approve").html(r)
                            $("#mdl_approve").modal("show");
                        })
                        //.fail(function (jqXHR, textStatus, error) {
                        //    stopSpin()
                        //    mg.warning("" + textStatus + "")
                        //});
                    }


                    $('#txt_search_checkno').on('keyup', function (e) {
                        
                        if (e.keyCode == 13) {
                            search_checkno()
                        }
                    })

                    function search_checkno() {
                        var gridData = $("#grid_transactions").data("kendoGrid");
                        if ($('#txt_search_checkno').val() == "") {
                            gridData.dataSource.filter({});
                        }
                        else {
                            ISfn.applyFilter("CheckNo", $('#txt_search_checkno').val(), 'grid_transactions')
                            /*gridData.dataSource.sort({ field: "CheckNo", dir: "asc" });*/
                        }
                    }
                </script>
                
                <div class="row">
                    @(Html.Kendo().Grid<WebAOMS.Models.CashBook_report_noBeginning>()
                    .Name("grid_transactions")
                    .Navigatable(a=> a.Enabled(true))
                    .Columns(columns =>
                    {
                        columns.Bound(m => m.Date).Width(70).Format("{0:MM/dd/yyyy}").Title("Date").HtmlAttributes(new { style = "text-align:center" }).HeaderHtmlAttributes(new { style = "text-align:center" });
                        columns.Bound(m => m.PTVNO).Width(100).Title("PTV No.").HtmlAttributes(new { style = "text-align:left" }).HeaderHtmlAttributes(new { style = "text-align:center" });
                        columns.Bound(m => m.Particular).Width(300).Title("Particular").HtmlAttributes(new { style = "text-align:left" }).HeaderHtmlAttributes(new { style = "text-align:center" });
                        columns.Bound(m => m.CheckNo).Width(80).Title("Ref/CheckNo/ADA").HtmlAttributes(new { style = "text-align:center" }).HeaderHtmlAttributes(new { style = "text-align:center" });
                        columns.Bound(m => m.DebitMonth).Width(80).Format("{0:N2}").Title("Debit").HtmlAttributes(new { style = "text-align:right" }).HeaderHtmlAttributes(new { style = "text-align:right" });
                        //.ClientFooterTemplate("<div style='text-align:right'><b><div id='t_debit'></div></b></div>");
                        columns.Bound(m => m.CreditMonth).Width(80).Title("Credit").Format("{0:N2}").HtmlAttributes(new { style = "text-align:right" }).HeaderHtmlAttributes(new { style = "text-align:right" });
                        //.ClientFooterTemplate("<div style='text-align:right'><b><div id='t_credit'></div></b></div>");
                        columns.Bound(m => m.Balance).Width(80).Title("Balance").Format("{0:N2}").HtmlAttributes(new { style = "text-align:right" }).HeaderHtmlAttributes(new { style = "text-align:center" });
                        //.ClientFooterTemplate("<div style='text-align:right'><b><div id='t_balance'></div></b></div>");
                    })

                    .AutoBind(false)
                    .HtmlAttributes(new { style = "height: 440px;" })
                    .Scrollable()
                    .Selectable(selectable => selectable
                            .Mode(GridSelectionMode.Single)
                            .Type(GridSelectionType.Row))

                    .Pageable(pageable => pageable
                    .Refresh(true)
                    .ButtonCount(5))
                    .DataSource(dataSource => dataSource
                        .Ajax()
                        .Read(read => read.Action("grid_CashBook_details", "Cashier").Data("para_rci_details"))
                        .PageSize(50000)
                    )
                    .Events(e => e.DataBound("onDataBound"))
                    )
                </div>
        
    </div>
</div>

<script>

    function onDataBound() {
        // get the grid
        var totaldebit = 0;
        var totalcredit = 0;
        var Begintotaldebit = 0;
        var Begintotalcredit = 0;

        var balance = 0;
        var previousBalance = 0;
        var grid = this;
        var counter = 1;
        // iterate through each row
        grid.tbody.find('>tr').each(function () {

            // get the row item
            var dataItem = grid.dataItem(this);
            // check for the condition
           
            if (dataItem.status == "1") {
                // add the formatting if condition is met
                $(this).addClass('bgGreen');
            }
            if (dataItem.status == "0") {
                // add the formatting if condition is met
                $(this).addClass('bgRed');
            }

            totaldebit = totaldebit + dataItem.DebitMonth
            totalcredit = totalcredit + dataItem.CreditMonth

            Begintotaldebit = Begintotaldebit + dataItem.Debit
            Begintotalcredit = Begintotalcredit + dataItem.Credit

            if (counter == 1) {
                previousBalance = dataItem.Balance
            }
            previousBalance = (previousBalance + dataItem.DebitMonth) - dataItem.CreditMonth

            counter++;
        })
        $("#txt_Credit").html(Begintotalcredit)
        $("#txt_Credit").number(true, 2);

        $("#txt_Debit").html(Begintotaldebit)
        $("#txt_Debit").number(true, 2);


        $("#t_credit").html(totalcredit)
        $("#t_credit").number(true, 2);

        $("#t_debit").html(totaldebit)
        $("#t_debit").number(true, 2);


        $("#txt_Balance").html(previousBalance)
        $("#txt_Balance").number(true, 2);

        $("#t_balance").html(previousBalance)
        $("#t_balance").number(true, 2);
    }

    $("#grid_transactions").on("dblclick", "tr.k-state-selected", function (e) {
        
            var row = $(e.target).closest("tr"),
            grid = $("#grid_transactions").data("kendoGrid"),
            dataItem = grid.dataItem(row);
            if (dataItem.trnno != 0) {
             show_cashbook_details(dataItem.trnno, dataItem.PTVNO)
            }
    });

    function show_cashbook_details(trnno,ptvno) {
        startSpin()
        $.post('@Url.Action("view_cashbook_details", "Cashier")', { trnno: trnno }, function (r) {
            $("#jev_content").html("")
            stopSpin()
            $("#txt_dvno").val(trnno)
            $("#h_jev_id").html("PTV No: " + ptvno)
            $("#jev_content").html(r)
            $("#mdl_jev").modal("show");
            $("#id_div_cf").hide();
        })
    }
    function isadjustment() {
        return 0;
    }
</script>

<div class="box">
    <div class="box-head">
        <header>
            <h4 class="text-bold">Account Summary</h4>
        </header>
        <div class="tools">
            <div class="btn-group ">
                <a class="btn btn-equal btn-sm btn-refresh"><i class="fa fa-refresh"></i></a>
                <a class="btn btn-equal btn-sm btn-collapse"><i class="fa fa-angle-down"></i></a>
            </div>
        </div>
        <hr />
    </div>
    <div class="box-body" style="padding-bottom:0px!important">
            <div class="row small-padding">
                <div class="col-md-4">
                    <div class="box box-type-pricing">
                        <div class="box-body text-left style-inverse">
                            <h3 class="text-sm">TOTAL DEBIT</h3>
                            <div class="price">
                                <span class="text-lg"></span><h2><span id="txt_Debit" class="text-light"></span></h2> <span></span>
                            </div>
                        </div>
                    </div><!--end .box -->
                </div><!--end .col-md-3 -->
                <div class="col-md-4">
                    <div class="box box-type-pricing style-inverse">
                        <div class="box-body text-left">
                            <h3 class="text-sm">TOTAL CREDIT</h3>
                            <div class="price">
                                <span class="text-lg"></span><h2><span id="txt_Credit" class="text-light"></span></h2> <span></span>
                            </div>
                        </div>
                    </div><!--end .box -->
                </div><!--end .col-md-3 -->
                <div class="col-md-4">
                    <div class="box box-type-pricing style-inverse">
                        <div class="box-body text-left">
                            <h3 class="text-sm">BALANCE</h3>
                            <div class="price">
                                <span class="text-lg"></span><h2><span id="txt_Balance" class="text-light"></span></h2>
                            </div>
                        </div>
                    </div><!--end .box -->
                </div><!--end .col-md-3 -->
                
            </div>
    </div>
</div>

<div class="modal" id="mdl_jev" data-backdrop="static" data-keyboard="false" role="dialog" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
                <h4 id="h_jev_id" class="modal-title"></h4>
            </div>
            <div id="body_jev" class="modal-body" style="height:auto!important">
                <input type="text" id="txt_dvno" hidden />
                <div id="jev_content" class="form-group-md col-md-12 no-padding" style="padding-top:10px">

                </div>
            </div>
            <div class="modal-footer">
                <button onclick="addRemark()" class="btn btn-success"> <i class="fa fa-list"></i> Action</button>
                <button type="button" class="btn btn-default" style="cursor:pointer" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
